#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sat Jul 27 14:25:25 2024

@author: hpc
"""

import subprocess
import json
import csv
import os
def run_adb_command(command):
    result = subprocess.run(command, capture_output=True, text=True)
    return result.stdout
def extract_ipc_features(package_name):
    features = {}
    
    # Get Activities
    activities = run_adb_command(['adb', 'shell', 'pm', 'dump', package_name])
    features['activities'] = [line for line in activities.splitlines() if 'MAIN' in line]
    
    # Get Broadcast Receivers
    receivers = run_adb_command(['adb', 'shell', 'pm', 'dump', package_name])
    features['broadcast_receivers'] = [line for line in receivers.splitlines() if 'BroadcastReceiver' in line]
    
    # Get Services
    services = run_adb_command(['adb', 'shell', 'pm', 'dump', package_name])
    features['services'] = [line for line in services.splitlines() if 'Service' in line]
    
    # Get Content Providers
    providers = run_adb_command(['adb', 'shell', 'pm', 'dump', package_name])
    features['content_providers'] = [line for line in providers.splitlines() if 'ContentProvider' in line]
    
    return features
def process_apks(apk_dir, output_dir):
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
    
    all_features = []
    
    for apk_file in os.listdir(apk_dir):
        if apk_file.endswith('.apk'):
            apk_path = os.path.join(apk_dir, apk_file)
            package_name = apk_file.replace('.apk', '')  # Assuming package name is same as apk file name
            
            features = extract_ipc_features(package_name)
            features['package_name'] = package_name
            
            all_features.append(features)
    
    # Save as JSON
    with open(os.path.join(output_dir, 'features.json'), 'w') as json_file:
        json.dump(all_features, json_file, indent=4)
    
    # Save as CSV
    with open(os.path.join(output_dir, 'features.csv'), 'w', newline='') as csv_file:
        writer = csv.writer(csv_file)
        writer.writerow(['package_name', 'activities', 'broadcast_receivers', 'services', 'content_providers'])
        for feature in all_features:
            writer.writerow([
                feature.get('package_name'),
                ', '.join(feature.get('activities', [])),
                ', '.join(feature.get('broadcast_receivers', [])),
                ', '.join(feature.get('services', [])),
                ', '.join(feature.get('content_providers', []))
            ])
apk_dir = '/home/hpc/Desktop/1 apk'
output_dir = '/home/hpc/Desktop/1 apk output'
process_apks(apk_dir, output_dir)
